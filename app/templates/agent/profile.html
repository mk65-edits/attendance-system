{% extends "dashboard_base.html" %}
{% block title %}Agent Profile{% endblock %}
{% block dashboard_content %}

<style>
    .profile-container {
        max-width: 1000px;
        margin: auto;
    }

    .profile-header {
        display: flex;
        gap: 30px;
        align-items: center;
        border-bottom: 2px solid #007bff;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    .profile-picture {
        width: 160px;
        height: 160px;
        border-radius: 10px;
        object-fit: cover;
        border: 3px solid #ccc;
    }

    .personal-info {
        flex-grow: 1;
    }

    .section-title {
        font-weight: 600;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-top: 30px;
    }

    textarea {
        resize: none;
        height: 80px;
    }

    .img-preview {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 5px;
    }

    .resume-preview {
        transition: all 0.3s ease;
    }

    .resume-preview:hover {
        transform: translateY(-2px);
        background-color: #f8f9fa;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
    }

    .reset-section {
        margin-top: 40px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #f8f9fa;
    }

    .toggle-password {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
</style>

<div class="container py-4 profile-container">
    <h3 class="mb-4 text-center">ðŸ‘¤ My Profile</h3>

    <form method="POST" enctype="multipart/form-data" id="profileForm" onsubmit="return validateForm();">

        <!-- Top Section -->
        <div class="profile-header">
            <div class="text-center">
                {% if user.profile_picture %}
                    <img src="{{ url_for('static', filename=user.profile_picture.split('static/')[-1]) }}" class="profile-picture mb-2">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default-profile.png') }}" class="profile-picture mb-2">
                {% endif %}
                {% if not user.profile_locked %}
                    <input type="file" name="profile_picture" class="form-control mt-2" accept="image/*" required>
                {% endif %}
            </div>

            <div class="personal-info">
                <div class="row g-3">
                    <div class="col-md-6"><span>*</span>
                        <label>First Name</label>
                        <input type="text" class="form-control" value="{{ user.first_name }}" readonly required>
                    </div>
                    <div class="col-md-6"><span>*</span>
                        <label>Last Name</label>
                        <input type="text" class="form-control" value="{{ user.last_name }}" readonly required>
                    </div>

                    <div class="col-md-6"><span>*</span>
                        <label>Father/Guardian Name</label>
                        <input type="text" name="father_name" class="form-control" 
                               value="{{ user.father_name or '' }}" {% if user.profile_locked %}readonly{% endif %} required>
                    </div>
                    <div class="col-md-6"><span>*</span>
                        <label>CNIC</label>
                        <input type="text" name="cnic" class="form-control" 
                               value="{{ user.cnic or '' }}" {% if user.profile_locked %}readonly{% endif %} maxlength="15" required>
                    </div>

                    <div class="col-md-6"><span>*</span>
                        <label>Contact Number (+92)</label>
                        <input type="text" name="contact_number" class="form-control" 
                               value="{{ user.contact_number or '+92 ' }}" {% if user.profile_locked %}readonly{% endif %} required>
                    </div>
                    <div class="col-md-6"><span>*</span>
                        <label>Whatsapp Number (+92)</label>
                        <input type="text" name="whatsapp_number" class="form-control" 
                               value="{{ user.whatsapp_number or '+92 ' }}" {% if user.profile_locked %}readonly{% endif %} required>
                    </div>
                    <div class="col-md-6"><span>*</span>
                        <label>Emergency Contact (+92)</label>
                        <input type="text" name="emergency_contact" class="form-control" 
                               value="{{ user.emergency_contact or '+92 ' }}" {% if user.profile_locked %}readonly{% endif %} required>
                    </div>
                    <div class="col-md-6"><span>*</span>
                        <label>Blood Group</label>
                        <input type="text" name="blood_group" class="form-control" 
                               value="{{ user.blood_group or '' }}" {% if user.profile_locked %}readonly{% endif %} required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h5 class="section-title">Address Information</h5><span>*</span>
                <label>Current Address</label>
                <textarea name="current_address" class="form-control" {% if user.profile_locked %}readonly{% endif %} required>{{ user.current_address or '' }}</textarea>

                <span>*</span><label class="mt-3">Permanent Address</label>
                <textarea name="permanent_address" class="form-control" {% if user.profile_locked %}readonly{% endif %} required>{{ user.permanent_address or '' }}</textarea>
            </div>

            <div class="col-md-6">
                <h5 class="section-title">Documents</h5>
                <div class="row g-3">
                    <div class="col-6"><span>*</span>
                        <label>Your CNIC Front</label>
                        {% if user.cnic_front %}
                            <img src="{{ url_for('static', filename=user.cnic_front.split('static/')[-1]) }}" class="img-preview">
                        {% endif %}
                        {% if not user.profile_locked %}
                            <input type="file" name="cnic_front" class="form-control" accept="image/*" required>
                        {% endif %}
                    </div>
                    <div class="col-6"><span>*</span>
                        <label>Your CNIC Back</label>
                        {% if user.cnic_back %}
                            <img src="{{ url_for('static', filename=user.cnic_back.split('static/')[-1]) }}" class="img-preview">
                        {% endif %}
                        {% if not user.profile_locked %}
                            <input type="file" name="cnic_back" class="form-control" accept="image/*" required>
                        {% endif %}
                    </div>

                    <div class="col-6"><span>*</span>
                        <label>Father/Guardian CNIC Front</label>
                        {% if user.guardian_cnic_front %}
                            <img src="{{ url_for('static', filename=user.guardian_cnic_front.split('static/')[-1]) }}" class="img-preview">
                        {% endif %}
                        {% if not user.profile_locked %}
                            <input type="file" name="guardian_cnic_front" class="form-control" accept="image/*" required>
                        {% endif %}
                    </div>
                    <div class="col-6"><span>*</span>
                        <label>Father/Guardian CNIC Back</label>
                        {% if user.guardian_cnic_back %}
                            <img src="{{ url_for('static', filename=user.guardian_cnic_back.split('static/')[-1]) }}" class="img-preview">
                        {% endif %}
                        {% if not user.profile_locked %}
                            <input type="file" name="guardian_cnic_back" class="form-control" accept="image/*" required>
                        {% endif %}
                    </div>

                    <div class="col-12"><span>*</span>
                        <label>Upload Resume (PDF)</label>
                        {% if user.resume_path %}
                            <div class="resume-preview border rounded p-3 bg-light text-center shadow-sm">
                                <i class="bi bi-file-earmark-pdf text-danger" style="font-size: 2rem;"></i>
                                <p class="mb-1 fw-semibold text-dark">Resume Uploaded</p>
                                <a href="{{ url_for('static', filename=user.resume_path.split('static/')[-1]) }}" 
                                   target="_blank" class="btn btn-outline-primary btn-sm">View Resume</a>
                            </div>
                        {% endif %}
                        {% if not user.profile_locked %}
                            <input type="file" name="resume_path" class="form-control mt-2" accept=".pdf" required>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 text-center">
            {% if not user.profile_locked %}
                <button class="btn btn-primary w-50">Save Profile</button>
            {% else %}
                <div class="alert alert-info">Your profile is locked. Contact admin for changes.</div>
            {% endif %}
        </div>
    </form>
</div>

<script>
    // CNIC Auto-format
    const cnicInput = document.querySelector('input[name="cnic"]');
    if (cnicInput) {
        cnicInput.addEventListener('input', function() {
            let v = this.value.replace(/\D/g, '');
            if (v.length > 5 && v.length <= 12)
                v = v.slice(0, 5) + '-' + v.slice(5);
            else if (v.length > 12)
                v = v.slice(0, 5) + '-' + v.slice(5, 12) + '-' + v.slice(12, 13);
            this.value = v;
        });
    }

    // Phone Auto-format as +92 XXX XXXXXXX
    const formatPhone = (input) => {
        let value = input.value.replace(/\D/g, '');
        if (!value.startsWith('92')) value = '92' + value;
        let formatted = '+92 ';
        if (value.length > 2) formatted += value.slice(2, 5);
        if (value.length > 5) formatted += ' ' + value.slice(5, 12);
        input.value = formatted.slice(0, 15);
    };

    document.querySelectorAll('input[name=contact_number], input[name=emergency_contact], input[name=whatsapp_number]')
        .forEach(el => el.addEventListener('input', () => formatPhone(el)));

    // Basic required field validation
    function validateForm() {
        const requiredFields = document.querySelectorAll('#profileForm [required]');
        for (let field of requiredFields) {
            if (!field.value.trim()) {
                alert('Please fill out all required fields before submitting.');
                field.focus();
                return false;
            }
        }
        return true;
    }
</script>

{% endblock %}
