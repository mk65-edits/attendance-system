{% extends "dashboard_base.html" %}
{% block title %}User Details - {{ user.username }}{% endblock %}

{% block dashboard_content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid py-3">

  <!-- Header -->

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h4 class="mb-2 mb-md-0">
      <i class="bi bi-person-lines-fill me-1"></i> {{ user.first_name }} {{ user.last_name }}'s Details
    </h4>
    <a href="{{ url_for('admin.manage_companies') }}" class="btn btn-outline-secondary btn-sm mt-2 mt-md-0">‚Üê Back</a>
  </div>

  <!-- Basic Information -->

  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body small">
      <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-person-badge me-1"></i> Basic Information</h6>
      <div class="row g-3">
        <div class="col-md-4"><strong>Username:</strong> {{ user.username }}</div>
        <div class="col-md-4"><strong>Email:</strong> {{ user.email }}</div>
        <div class="col-md-4"><strong>Role:</strong> {{ user.role }}</div>
        <div class="col-md-4"><strong>Company:</strong> {{ user.company.name if user.company else '-' }}</div>
        <div class="col-md-4"><strong>Shift:</strong> {{ user.shift or '-' }}</div>
        <div class="col-md-4"><strong>Status:</strong> {{ 'Active' if user.is_active else 'Disabled' }}</div>
        <div class="col-md-4"><strong>Created:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</div>

          {% set delta = (current_time - user.created_at) %}
          {% set years = delta.days // 365 %}
          {% set months = (delta.days % 365) // 30 %}
          {% set days = (delta.days % 365) % 30 %}
          <div class="col-md-4"><strong>Tenure:</strong> {{ years }}y {{ months }}m {{ days }}d</div>

        <div class="col-md-4"><strong>Basic Salary:</strong> Rs. {{ user.salary or 0 }}</div>
      </div>
    </div>
  </div>

  <!-- Attendance Summary -->

  <div class="accordion" id="attendanceAccordion">
    <div class="accordion-item shadow-sm border-0">
      <h2 class="accordion-header" id="headingSummary">
        <button class="accordion-button fw-semibold" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapseSummary" aria-expanded="true" aria-controls="collapseSummary">
          üìä Attendance Summary (By Month)
        </button>
      </h2>

  <div id="collapseSummary" class="accordion-collapse collapse show" aria-labelledby="headingSummary"
    data-bs-parent="#attendanceAccordion">
    <div class="accordion-body">

      {% if monthly_data %}
        <div class="accordion" id="monthAccordion">
          {% for month, records in monthly_data.items() %}
          {% set total_presents = records | selectattr('status', 'equalto', 'Present') | list | length %}
          {% set total_lates = records | selectattr('is_late') | list | length %}
          {% set total_absents = records | selectattr('status', 'equalto', 'Absent') | list | length %}
          {% set total_offs = records | selectattr('status', 'equalto', 'Off') | list | length %}

          <div class="accordion-item mb-2 border-0 shadow-sm">
            <h2 class="accordion-header" id="heading-{{ loop.index }}">
              <button class="accordion-button collapsed small" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false"
                aria-controls="collapse-{{ loop.index }}">
                <div class="w-100 d-flex justify-content-between flex-wrap">
                  <span><strong>{{ month }}</strong></span>
                  <span class="text-end">
                    <span class="badge bg-success-subtle text-success">Presents: {{ total_presents }}</span>
                    <span class="badge bg-warning-subtle text-warning">Lates: {{ total_lates }}</span>
                    <span class="badge bg-danger-subtle text-danger">Absents: {{ total_absents }}</span>
                    <span class="badge bg-secondary-subtle text-secondary">Offs: {{ total_offs }}</span>
                  </span>
                </div>
              </button>
            </h2>

            <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
              aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#monthAccordion">
              <div class="accordion-body p-2">
                <div class="table-responsive">
                  <table class="table table-sm table-bordered text-center align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Late</th>
                        <th>Marked By</th>
                        <th>Shift</th>
                        <th>Bonus</th>
                        <th>Penalty</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for record in records %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ record.date.strftime('%Y-%m-%d') }}</td>
                        <td>
                          {% if record.status == 'Present' %}
                            <span class="text-success fw-semibold">Present</span>
                          {% elif record.status == 'Late' %}
                            <span class="text-warning fw-semibold">Late</span>
                          {% elif record.status == 'Off' %}
                            <span class="text-primary fw-semibold">Off</span>
                          {% else %}
                            <span class="text-danger fw-semibold">Absent</span>
                          {% endif %}
                        </td>
                        <td>{{ 'Yes' if record.is_late else 'No' }}</td>
                        <td>{{ record.marker.full_name if record.marker else '-' }}</td>
                        <td>{{ record.shift or user.shift or '-' }}</td>
                        <td>Rs. {{ record.bonus or 0 }}</td>
                       <!-- ‚úÖ Penalty column with tooltip showing all penalties of that date -->
                        <td class="text-danger"
                            {% if record.penalty_details %}
                              data-bs-toggle="tooltip"
                              data-bs-html="true"
                              data-bs-placement="top"
                              title="
                              {% for p in record.penalty_details %}
                                üí∞ <strong>Rs. {{ p.amount }}</strong> ‚Äî {{ p.reason }}<br>
                                <small>üë§ Added by: {{ p.added_by }}</small><br>
                              {% endfor %}
                              ">
                            {% endif %}
                            {% if record.penalty_details and record.penalty_details|length > 0 %}
                              Rs. {{ record.penalty_details | map(attribute='amount') | sum }}
                            {% else %}
                              Rs. 0
                            {% endif %}
                        </td>

                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-muted py-4">
          <i class="bi bi-inbox fs-3 mb-2"></i>
          <p>No attendance data found.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

  </div>
</div>

<style>
.accordion-button {
  font-size: 0.9rem;
  padding: 0.5rem 1rem;
}
.accordion-body {
  font-size: 0.85rem;
}
.table th, .table td {
  vertical-align: middle;
  white-space: nowrap;
}
.tooltip-inner {
  max-width: 260px;
  text-align: left;
  white-space: normal;
  font-size: 0.85rem;
  background-color: #343a40;
}
@media (max-width: 768px) {
  .accordion-button {
    font-size: 0.85rem;
  }
  .table {
    font-size: 0.8rem;
  }
}
</style>

<!-- ‚úÖ Bootstrap Tooltip Activation -->

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});
</script>

{% endblock %}
