{% extends "dashboard_base.html" %}
{% block title %}View Users - Office Connect{% endblock %}

{% block dashboard_content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid py-3">

  <!-- ðŸ”¹ Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-eye-fill"></i> View Users</h4>
  </div>

  <!-- ðŸ”¹ Filters + Download Buttons (same row) -->
  <div class="row g-2 align-items-center mb-4">
    <div class="col-12 col-md-3">
      <input type="text" id="userSearch" class="form-control" placeholder="ðŸ” Search by name, email, or username">
    </div>
    <div class="col-6 col-md-2">
      <select id="companyFilter" class="form-select">
        <option value="">All Companies</option>
        {% for company in companies %}
        <option value="{{ company.id }}">{{ company.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <select id="shiftFilter" class="form-select">
        <option value="">All Shifts</option>
        <option value="morning">Morning</option>
        <option value="evening">Evening</option>
        <option value="night">Night</option>
      </select>
    </div>
    <div class="col-12 col-md-5 text-md-end text-center">
      <a href="{{ url_for('admin.download_all_users', format='csv') }}" class="btn btn-outline-primary btn-sm me-1">
        <i class="bi bi-file-earmark-spreadsheet"></i> Download CSV
      </a>
      <a href="{{ url_for('admin.download_all_users', format='pdf') }}" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-file-earmark-pdf"></i> Download PDF
      </a>
    </div>
  </div>

  <!-- ðŸ”¹ Users Table -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle text-end">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Username</th>
            <th>Company</th>
            <th>Shift</th>
            <th>Created</th>
            <th>Tenure</th>
            <th>Salary</th>
            <th>Travel Allowance</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          {% for user in users %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ user.first_name }} {{ user.last_name }}</td>
            <td>{{ user.username }}</td>
            <td>{{ user.company.name if user.company else '-' }}</td>
            <td>{{ user.shift or '-' }}</td>
            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>

            {% set delta = (current_time - user.created_at) %}
            {% set years = delta.days // 365 %}
            {% set months = (delta.days % 365) // 30 %}
            {% set days = (delta.days % 365) % 30 %}
            <td>{{ years }}y {{ months }}m {{ days }}d</td>

            <td>Rs. {{ user.salary or 0 }}</td>
            <td>Rs. {{ user.travel_allowance_amount or 0 }}</td>
            <td>
              <span class="badge {{ 'bg-success' if user.is_active else 'bg-secondary' }}">
                {{ 'Active' if user.is_active else 'Disabled' }}
              </span>
            </td>
            <td class="text-end">
              <a href="{{ url_for('admin.view_user_details', user_id=user.id) }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye"></i> View
              </a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="11" class="text-center py-3">No users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- âœ… Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// âœ… Simple client-side filter logic
document.getElementById('userSearch').addEventListener('input', filterUsers);
document.getElementById('companyFilter').addEventListener('change', filterUsers);
document.getElementById('shiftFilter').addEventListener('change', filterUsers);

function filterUsers() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const company = document.getElementById('companyFilter').value;
  const shift = document.getElementById('shiftFilter').value;
  const rows = document.querySelectorAll('#userTableBody tr');

  rows.forEach(row => {
    const name = row.children[1]?.innerText.toLowerCase();
    const username = row.children[2]?.innerText.toLowerCase();
    const companyText = row.children[3]?.innerText.toLowerCase();
    const shiftText = row.children[4]?.innerText.toLowerCase();

    const matchesSearch = !search || name.includes(search) || username.includes(search);
    const matchesCompany = !company || companyText.includes(company);
    const matchesShift = !shift || shiftText.includes(shift);

    row.style.display = (matchesSearch && matchesCompany && matchesShift) ? '' : 'none';
  });
}
</script>
{% endblock %}
