{% extends "dashboard_base.html" %}
{% block title %}Manage Users - Office Connect{% endblock %}

{% block dashboard_content %}
<!-- âœ… Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">


<style>
/* ---------------- THEME CONSISTENCY ---------------- */
.manage-users-wrapper {
  background: #f9fafc;
  padding: 25px;
  border-radius: 16px;
  box-shadow: 0 4px 18px rgba(0, 0, 0, 0.05);
}

/* Section Headings */
h5.section-title {
  color: #1e3a8a;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

/* Search & Filter Bar */
.filter-bar {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  padding: 15px;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  border-radius: 10px;
  border: 1px solid #d1d5db;
  box-shadow: none;
}

.filter-bar .btn-primary {
  background-color: #2563eb;
  border: none;
  border-radius: 10px;
  transition: 0.3s;
}
.filter-bar .btn-primary:hover {
  background-color: #1d4ed8;
}

/* Table */
.card {
  border-radius: 14px;
  overflow: hidden;
  border: none;
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.05);
}

.card-header {
  background: #f8fafc !important;
  border-bottom: 1px solid #e5e7eb;
}

.table {
  margin-bottom: 0;
  border-radius: 12px;
}

.table thead {
  background: #2563eb;
  color: #ffffff;
}

.table th {
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 12px 10px;
}

.table td {
  vertical-align: middle;
  color: #374151;
  font-size: 0.95rem;
  padding: 12px 10px;
}

/* Buttons */
.btn-outline-danger,
.btn-outline-success,
.btn-outline-warning {
  border-radius: 8px;
  font-weight: 500;
  padding: 4px 10px;
}

.btn-outline-danger:hover {
  background: #dc2626;
  color: #fff;
}

.btn-outline-success:hover {
  background: #16a34a;
  color: #fff;
}

.btn-outline-warning:hover {
  background: #eab308;
  color: #fff;
}

/* Modal */
.modal-content {
  border-radius: 14px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.modal-header {
  background: #2563eb;
  color: white;
  border-top-left-radius: 14px;
  border-top-right-radius: 14px;
}

.modal-title i {
  margin-right: 8px;
}

.modal-footer {
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.modal .btn-primary {
  background-color: #2563eb;
  border: none;
  border-radius: 10px;
}

.modal .btn-primary:hover {
  background-color: #1d4ed8;
}

/* Validation Styles */
.is-invalid { border-color: #dc3545 !important; }
.is-valid { border-color: #198754 !important; }

/* Responsive Adjustments */
@media (max-width: 992px) {
  .filter-bar {
    flex-direction: column;
  }
  .table th, .table td {
    font-size: 0.85rem;
  }
}
</style>


    <!-- ðŸ”¹ Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="section-title mb-0"><i class="bi bi-people-fill"></i> All Users</h4>
    </div>

  <!-- ðŸ”¹ Search + Filters -->
  <div class="filter-bar row g-2 align-items-center">
      <div class="col-12 col-md-4">
          <input type="text" id="userSearch" class="form-control" placeholder="ðŸ” Search users by name, email, or username">
      </div>
      <div class="col-6 col-md-3">
          <select id="companyFilter" class="form-select">
              <option value="">All Companies</option>
              {% for company in companies %}
                  <option value="{{ company.id }}">{{ company.name }}</option>
              {% endfor %}
          </select>
      </div>
      <div class="col-6 col-md-3">
          <select id="shiftFilter" class="form-select">
              <option value="">All Shifts</option>
              <option value="morning">Morning</option>
              <option value="evening">Evening</option>
              <option value="night">Night</option>
          </select>
      </div>
      <div class="col-12 col-md-2 text-md-end">
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addUserModal">
              <i class="bi bi-person-plus-fill"></i> Add User
          </button>
      </div>
  </div>

  <!-- ðŸ”¹ Users Table -->
  <div class="card">
 
      <div class="table-responsive">
          <table class="table align-middle">
              <thead>
                  <tr>
                      <th>#</th>
                      <th>Full Name</th>
                      <th>Username</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Company</th>
                      <th>Salary</th>
                      <th>Allowance</th>
                      <th>Shift</th>
                      <th>Created</th>
                      <th>Status</th>
                  </tr>
              </thead>
              <tbody id="userTableBody">
                  {% for user in users %}
                  <tr data-company-id="{{ user.company.id if user.company else '' }}">
                      <td>{{ loop.index }}</td>
                      <td>{{ user.first_name }} {{ user.last_name }}</td>
                      <td>{{ user.username }}</td>
                      <td>{{ user.email }}</td>
                      <td>{{ user.role|capitalize }}</td>
                      <td>{{ user.company.name if user.company else '-' }}</td>
                      <td>
                          {% if user.salary is not none %}
                              {{ "%.2f"|format(user.salary) }}
                          {% else %}
                              -
                          {% endif %}
                      </td>
                      <td>
                          {% if user.travel_allowance_eligible %}
                              <span class="badge bg-success">Yes ({{ user.travel_allowance_amount or 0 }})</span>
                          {% else %}
                              <span class="badge bg-secondary">No</span>
                          {% endif %}
                      </td>
                      <td>{{ user.shift or '-' }}</td>
                      <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <!-- ðŸ”“ Unlock Profile -->
                      <td class="text-center">
                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-1">

                          <form method="POST" action="{{ url_for('admin.unlock_profile', user_id=user.id) }}">
                            <button type="submit" class="btn btn-sm {{ 'btn-outline-danger' if user.profile_locked else 'btn-outline-success' }}">
                              {% if user.profile_locked %}
                                <i class="bi bi-lock-fill"></i>
                              {% else %}
                                <i class="bi bi-unlock-fill"></i>
                              {% endif %}
                            </button>
                          </form>

                          <form method="POST" action="{{ url_for('admin.toggle_user', user_id=user.id) }}">
                            <button type="submit" class="btn btn-sm {{ 'btn-outline-danger' if user.is_active else 'btn-outline-success' }}">
                              {{ 'Disable' if user.is_active else 'Enable' }}
                            </button>
                          </form>

                          <form method="POST" 
                                action="{{ url_for('admin.reset_password', user_id=user.id) }}" 
                                onsubmit="return confirm('Are you sure you want to reset this user\'s password to Default@1234?');">
                            <button type="submit" class="btn btn-sm btn-outline-warning">
                              <i class="bi bi-key-fill"></i> Reset
                            </button>
                          </form>

                        </div>
                      </td>

                  </tr>
                  {% else %}
                  <tr><td colspan="12" class="text-center py-3 text-muted">No users found.</td></tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
  </div>


<!-- ðŸ”¹ Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="addUserForm" method="POST" action="{{ url_for('admin.save_user') }}" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel"><i class="bi bi-person-plus-fill"></i> Add New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">


          <div class="row g-3">
              <div class="col-md-6">
                  <label class="form-label">First Name *</label>
                  <input type="text" name="firstName" class="form-control" required>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Last Name *</label>
                  <input type="text" name="lastName" class="form-control" required>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Username *</label>
                  <input type="text" name="username" class="form-control" required>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Email *</label>
                  <input type="email" name="email" class="form-control" required>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Role *</label>
                  <select name="role" class="form-select" required>
                      <option value="">Select role</option>
                      <option value="agent">Agent</option>
                      <option value="supervisor">Supervisor</option>
                      <option value="admin">Admin</option>
                  </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Company *</label>
                  <select name="company" class="form-select" required>
                        <option value="">Select Company</option>
                        {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                  </select>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Salary *</label>
                  <input type="number" name="salary" class="form-control" min="0" step="0.01" required>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Shift *</label>
                  <select name="shift" class="form-select" required>
                      <option value="">Select shift</option>
                      <option value="morning">Morning</option>
                      <option value="evening">Evening</option>
                      <option value="night">Night</option>
                  </select>
              </div>
              <div class="col-md-6">
                  <label class="form-label">Travel Allowance Eligible?</label>
                  <select name="allowance" id="allowanceSelect" class="form-select">
                      <option value="no">No</option>
                      <option value="yes">Yes</option>
                  </select>
              </div>
              <div class="col-md-6" id="allowanceAmountWrap" style="display:none;">
                  <label class="form-label">Allowance Amount</label>
                  <input type="number" name="allowance_amount" class="form-control" min="0" required>
              </div>
              <div class="col-md-12">
                  <label class="form-label">Default Password</label>
                  <input type="text" name="password" value="Default@1234" class="form-control" readonly>
              </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save User</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- âœ… JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById('allowanceSelect').addEventListener('change', function() {
  document.getElementById('allowanceAmountWrap').style.display = (this.value === 'yes') ? 'block' : 'none';
});

document.getElementById('userSearch').addEventListener('input', filterUsers);
document.getElementById('companyFilter').addEventListener('change', filterUsers);
document.getElementById('shiftFilter').addEventListener('change', filterUsers);

function filterUsers() {
  const search = document.getElementById('userSearch').value.toLowerCase();
  const company = document.getElementById('companyFilter').value;
  const shift = document.getElementById('shiftFilter').value;
  const rows = document.querySelectorAll('#userTableBody tr');

  rows.forEach(row => {
    const name = row.children[1]?.innerText.toLowerCase();
    const email = row.children[3]?.innerText.toLowerCase();
    const role = row.children[4]?.innerText.toLowerCase();
    const companyId = row.getAttribute('data-company-id');
    const shiftText = row.children[8]?.innerText.toLowerCase();
    const matchesSearch = !search || name.includes(search) || email.includes(search) || role.includes(search);
    const matchesCompany = !company || companyId === company;
    const matchesShift = !shift || shiftText === shift;
    row.style.display = (matchesSearch && matchesCompany && matchesShift) ? '' : 'none';
  });
}

const fieldsToValidate = ["username", "email"];
fieldsToValidate.forEach(fieldName => {
  const input = document.querySelector(`[name="${fieldName}"]`);
  if (!input) return;
  const errorSpan = document.createElement("small");
  errorSpan.classList.add("text-danger", "d-block", "mt-1");
  input.parentElement.appendChild(errorSpan);
  input.addEventListener("input", async () => {
    const value = input.value.trim();
    if (!value) {
      errorSpan.textContent = "";
      input.classList.remove("is-invalid", "is-valid");
      return;
    }
    try {
      const response = await fetch("{{ url_for('admin.validate_user_input') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ field: fieldName, value }),
      });
      const result = await response.json();
      if (result.valid) {
        input.classList.remove("is-invalid");
        input.classList.add("is-valid");
        errorSpan.textContent = "";
      } else {
        input.classList.remove("is-valid");
        input.classList.add("is-invalid");
        errorSpan.textContent = result.error || "Invalid input.";
      }
    } catch (err) {
      console.error("Validation failed:", err);
    }
  });
});
</script>
{% endblock %}
